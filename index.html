<!DOCTYPE html>
<script type="_importmap">{ "imports": {
	"sql.mjs": "https://unpkg.com/sql.mjs"	
}}</script>
<script type="importmap">{ "imports": {
	"sql.mjs": "/dist/index.mjs"
}}</script>
<script type="module">
	import {
		Conn, OpenParams, exec, SqliteBlob
	} from 'sql.mjs';

	const conn = new Conn();
	await conn.open(new OpenParams({pathname: 'test.db'}));

	// Create the files tables
	await exec(conn.sql`
CREATE TABLE IF NOT EXISTS files (
	filename TEXT NOT NULL UNIQUE,
	data BLOB NOT NULL,
	type TEXT DEFAULT 'text/plain'
) STRICT;`);


	const list = document.createElement('ul');
	document.body.append(list);
	for await (const {filename, rowid, type, size} of conn.sql`SELECT rowid, filename, type, length(data) AS size FROM files`) {
		const li = document.createElement('li');
		li.innerText = `${filename} - ${size}b - ${type}`;
		list.append(li);
	}

	const file_select = document.createElement('input');
	file_select.setAttribute('type', 'file');
	document.body.append(file_select);

	file_select.addEventListener('input', async ({ target: { files }}) => {
		for (const file of files) {
			console.log(file);
			// Insert the file into the files table:
			const [rowid] = await exec(conn.sql`
				BEGIN;
				INSERT INTO files VALUES (${file.name}, zeroblob(${file.size}), ${file.type});
				SELECT last_insert_rowid();
			`);
			const blob = await SqliteBlob.open(conn, 'files', 'data', rowid);;
			await blob.write_from(file.stream());
			await blob.close();
			await exec(conn.sql`COMMIT`);
		}
	});

	// console.log(await rows(sql`SELECT test_func(randomblob(9))`));
</script>
