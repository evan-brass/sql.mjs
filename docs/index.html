<!DOCTYPE html>
<html>
<head>
	<title>sql.mjs - SQLite </title>
	<style>
		code {
			display: inline-block;
			background-color: #eee;
			padding: 0.5em;
			font-size: 0.9em;
		}
		html {
			font-size: 16px;
			line-height: 1.5;
			font-family: sans-serif;
		}
		main {
			max-width: 90ch;
			margin: 1em auto;
		}
		textarea {
			box-sizing: border-box;
			width: 100%;
			min-height: 10em;
		}
	</style>
	<!-- <base href="/docs/"> -->
</head>
<body>
	<main>
		<h1>sql.mjs demo</h1>
		<p><output id="dbname">[no db open]</output></p>
		<p><textarea placeholder="SELECT 'Hello World!';"></textarea></p>
		<button id="eval">Eval</button>
		<pre style="word-wrap: break-word; white-space: break-spaces; background-color: #eee; padding: 1em; border: 1px solid #aaa;">Output:<br><output id="result"></output></pre>
		<script type="module">
			// import { open as open_db, sqlite3, register_vfs, opfs, alloc_str, read_str, make_sql, AsObject } from 'https://unpkg.com/sql.mjs@0.3.1';
			import {
				Conn, open,
				SQLITE_OPEN_READONLY,
				SQLITE_OPEN_READWRITE,
				SQLITE_OPEN_CREATE,
				SQLITE_OPEN_URI,
				SQLITE_OPEN_MEMORY,
				SQLITE_OPEN_NOMUTEX,
				SQLITE_OPEN_FULLMUTEX,
				SQLITE_OPEN_SHAREDCACHE,
				SQLITE_OPEN_PRIVATECACHE,
				SQLITE_OPEN_NOFOLLOW,
				SQLITE_OPEN_EXRESCODE,
			} from '/dist/index.mjs';

			const conn = new Conn();

			const eval_btn = document.querySelector('#eval');
			const result = document.querySelector('#result');
			const code = document.querySelector('textarea');
			const dbname = document.querySelector('#dbname');
			function update_ui() {
				dbname.innerText = conn.filename;
			}
			update_ui();
			function abort() {
				conn.interrupt();
			}
			async function evaluate() {
				const orig_txt = eval_btn.innerText;
				eval_btn.innerText = 'Abort';
				eval_btn.onclick = abort;

				result.innerText = '';
				try {
					const res = eval('conn.sql`' + code.value + '`');
					for await (const row of res) {
						for (const key in row) {
							if (row[key] instanceof Uint8Array) row[key] = Array.from(row[key]);
						}
						result.insertAdjacentText('beforeend', JSON.stringify(row) + '\n');
						update_ui();
					}
				} catch (e) {
					result.insertAdjacentHTML('beforeend', `<span style="color: red">${e.toString()}</span>`);
				}
				eval_btn.innerText = orig_txt;
				eval_btn.onclick = evaluate;

				update_ui();
			}
			eval_btn.onclick = evaluate;

			// Make it so that you can copy code snippets into the text area:
			document.body.addEventListener('click', e => {
				if (e.target.matches('code')) {
					document.querySelector('textarea').value = e.target.innerText;
				}
			});
		</script>

		<h2>Examples</h2>
		<p>A few things you could try playing around with are: (click the code samples)</p>
		<ul>
			<li>Syntax errors: <code>not sql</code></li>
			<li>Use Date/Time or random functions: <code>SELECT hex(randomblob(20)) AS random, date() AS date;</code></li>
			<li>Blob literals are not supported, but you can bind TypedArrays as arguments: <code>SELECT hex(${new Uint8Array([222, 173, 190, 239])});</code></li>
			<li>Make a table: <code>CREATE TABLE IF NOT EXISTS todo(title TEXT, description TEXT, priority INT);</code></li>
			<li>Insert some data into that table: <pre><code>INSERT INTO todo VALUES 
	('go for a walk', '*if it isn''t too cold', 3),
	('do dishes', '*they would''ve been easier to do yesterday...*', 5),
	('feed the dog', null, '4.5');</code></pre></li>
			<li>List your todos: <code>SELECT title, description FROM todo ORDER BY priority DESC;</code></li>
			<li>Do pragma things: <code>PRAGMA table_list;</code></li>
		</ul>
		<h2>Non-memory Databases</h2>
		<p>By default, you'll be connected to an in-memory database which will be lost on refresh.  You can change that by using the open command.</p>
		<p>These commands are equivalent - they open test.db inside the Origin-Private-File-System:</p>
		<ul>
			<li><code>${open`test.db${'opfs'}`}</code></li>
			<li><code>${open`file://localhost/test.db?vfs=opfs`}</code></li>
		</ul>
		<p>But we can do more interesting things.  These commands open databases using the open / save file pickers:</p>
		<h3>Show the open file picker:</h3>
		<ul>
			<li><code>${open`open${'picker'}`}</code></li>
			<li><code>${open`file://localhost?vfs=picker`}</code></li>
		</ul>
		<h3>Show the save file picker:</h3>
		<ul>
			<li><code>${open`file://suggested_name?vfs=picker&save=true`}</code></li>
		</ul>
		<p>For Origin-Private-File-System database files, writable permission is always granted.  For databases opened through the file pickers are readable.  Attempting to write to a file-picker database for the first time will trigger a browser permission prompt.  File pickers and permission prompts require that you call Conn.sql from a <a href="https://developer.mozilla.org/en-US/docs/Web/Security/User_activation">user gesture</a>.</p>
		<h3>Open Databases Over HTTP(S)</h3>
		<ul>
			<li><code>${open`file://cdn.jsdelivr.net/gh/alex-hofsteede/zipcode_db/zipcodes.sqlite?vfs=http&https=on`}</code></li>
		</ul>
		<p>For example, with this zipcodes.sqlite database open, we can find all of the zipcodes in the state of Oregon:</p>
<pre><code>SELECT zip, cities.name AS city FROM zipcodes
INNER JOIN cities ON cities.id = zipcodes.city_id
WHERE state_id = (SELECT id FROM states WHERE name = 'OR');</code></pre>
		<p>This is a pretty long operation because (with this databases indexes) this requires a full table scan.  The HTTP VFS uses the Range header to do partial reads.  This database uses a 4.5kb page size, but a larger page size would probably be better.</p>
		<h2>Possible Use-Cases</h2>
		<ul>
			<li>Adding Full-Text search to a static website: <a href="https://www.sqlite.org/fts5.html">https://www.sqlite.org/fts5.html</a></li>
			<li>Building content management systems that run client-side - potentially inside the service worker.</li>
			<li>Editing SQLite databases without needing to install any software.</li>
			<li>Building interactive SQL education materials.</li>
			<li>Using R-Trees to create calendar widgets: <a href="https://www.sqlite.org/rtree.html">https://www.sqlite.org/rtree.html</a></li>
			<li>Building exporters that help people retrieve their data from various online platforms.  This could maybe facilitate user-mobility between / away from walled gardens.</li>
		</ul>
	</main>
</body>
</html>
